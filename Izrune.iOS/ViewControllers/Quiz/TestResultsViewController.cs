// This file has been autogenerated from a class added in the UI designer.

using System;

using Foundation;
using Izrune.iOS.CollectionViewCells;
using MPDCiOSPages.ViewControllers;
using UIKit;
using FPT.Framework.iOS.UI.DropDown;
using Izrune.iOS.Utils;
using System.Threading.Tasks;
using IZrune.PCL.Abstraction.Services;
using System.Linq;
using System.Collections.Generic;
using IZrune.PCL.Abstraction.Models;
using MpdcViewExtentions;
using XLPagerTabStrip;
using System.Globalization;

namespace Izrune.iOS
{
	public partial class TestResultsViewController : BaseViewController, IUICollectionViewDelegate, IUICollectionViewDataSource, IUICollectionViewDelegateFlowLayout, IIndicatorInfoProvider
    {
		public TestResultsViewController (IntPtr handle) : base (handle)
		{
		}

        public static readonly NSString StoryboardId = new NSString("TestResultsStoryboardId");

        DropDown YearDropDown = new DropDown();
        DropDown MonthDropDown = new DropDown();

        private List<IStudentsStatistic> StudentsStatistics;

        private List<IStudentsStatistic> OriginalList = new List<IStudentsStatistic>();

        public bool Hideheader = true;
        private CultureInfo cultureInfo;

        public async override void ViewDidLoad()
        {
            base.ViewDidLoad();

            await LoadDataAsync();

            InitUI();

            InitDroDown();

            InitGestures();

            InitCollectionViewSettings();

            HideHeader(Hideheader);

            resultCollectionView.ReloadData();

        }

        private void InitUI()
        {
            headerView.Layer.CornerRadius = 15;
            viewForShadow.AddShadowToView(5, 15, 0.5f, UIColor.FromRGBA(0, 0, 0, 38.5f));

            var dates = dateStackView.Subviews.ToList();
            var results = testResultStackView.Subviews.ToList();

            for (int i = 0; i < dates.Count; i++)
            {
                dates[i].Layer.CornerRadius = 17;
                results[i].Layer.CornerRadius = 17;
            }
        }

        private void HideAll(bool hide)
        {
            headerView.Hidden = hide;
            viewForShadow.Hidden = hide;
            mainStackView.Hidden = hide;
            statisticStackView.Hidden = hide;
        }

        public async Task LoadDataAsync()
        {

            HideAll(true);
            ShowLoading();

            var diplomeService = ServiceContainer.ServiceContainer.Instance.Get<IStatisticServices>();

            StudentsStatistics = (await diplomeService.GetStudentStatisticsAsync(IZrune.PCL.Enum.QuezCategory.QuezTest))?.ToList();

            foreach (var item in StudentsStatistics)
            {
                OriginalList.Add(item);
            }

            HideAll(false);
            EndLoading();
        }

        private void InitCollectionViewSettings()
        {
            resultCollectionView.RegisterNibForCell(ResultCollectionViewCell.Nib, ResultCollectionViewCell.Identifier);
            resultCollectionView.Delegate = this;
            resultCollectionView.DataSource = this;
        }

        public void HideHeader(bool hide)
        {
            viewForShadow.Hidden = hide;
            resultStackView.Hidden = hide;
            headerView.Hidden = hide;
            headerLine.Hidden = hide;
        }

        #region CollectionView

        public nint GetItemsCount(UICollectionView collectionView, nint section)
        {
            return StudentsStatistics?.Count ?? 0;
        }

        public UICollectionViewCell GetCell(UICollectionView collectionView, NSIndexPath indexPath)
        {
            var resultCell = resultCollectionView.DequeueReusableCell(ResultCollectionViewCell.Identifier, indexPath) as ResultCollectionViewCell;

            var data = StudentsStatistics?[indexPath.Row];

            resultCell.InitData(data);

            return resultCell;
        }

        [Export("collectionView:layout:sizeForItemAtIndexPath:")]
        public CoreGraphics.CGSize GetSizeForItem(UICollectionView collectionView, UICollectionViewLayout layout, NSIndexPath indexPath)
        {
            return new CoreGraphics.CGSize(collectionView.Frame.Width, 210);
        }

        #endregion

        private void InitDroDown()
        {
            YearDropDown.AnchorView = new WeakReference<UIView>(yearDropdownView);
            YearDropDown.BottomOffset = new CoreGraphics.CGPoint(0, yearDropdownView.Bounds.Height);
            YearDropDown.Width = this.View.Frame.Width;
            YearDropDown.Direction = Direction.Bottom;

            var minYear = StudentsStatistics?.Min(x => x.ExamDate);
            var maxYear = StudentsStatistics?.Max(x => x.ExamDate);

            var yearArray = GetYears(minYear, maxYear);

            YearDropDown.DataSource = yearArray;

            YearDropDown.SelectionAction = (nint index, string name) =>
            {
                yearLbl.Text = name;

                if(index == 0)
                {
                    StudentsStatistics = OriginalList;
                    resultCollectionView.ReloadData();
                    return;
                }

                StudentsStatistics = OriginalList?.Where(x => x.ExamDate.Year == Convert.ToInt32(name))?.ToList();
                resultCollectionView.ReloadData();
            };

            MonthDropDown.AnchorView = new WeakReference<UIView>(monthDropdownView);
            MonthDropDown.BottomOffset = new CoreGraphics.CGPoint(0, monthDropdownView.Bounds.Height);
            MonthDropDown.Width = this.View.Frame.Width;
            MonthDropDown.Direction = Direction.Bottom;

            var monthArray = GetMonth();

            MonthDropDown.DataSource = monthArray;
            MonthDropDown.SelectionAction = (nint index, string name) =>
            {
                monthLbl.Text = name;

                if(index == 0)
                {
                    StudentsStatistics = OriginalList;
                    resultCollectionView.ReloadData();
                    return;
                }

                StudentsStatistics = OriginalList?.Where(x => x.ExamDate.Month == index)?.ToList();
                resultCollectionView.ReloadData();

                if(StudentsStatistics == null || StudentsStatistics?.Count == 0)
                {
                    ShowAlert();
                }
            };
        }

        private void ShowAlert()
        { 
            var alert = UIAlertController.Create("შეცდომა", "ინფორმაცია ვერ მოიძებნა.", UIAlertControllerStyle.Alert);
            alert.AddAction(UIAlertAction.Create("დახურვა", UIAlertActionStyle.Default, null));
            this.PresentViewController(alert, true, null);
        }

        private void InitDropDownUI()
        {
            YearDropDown.BackgroundColor = UIColor.FromRGB(243, 243, 243);
            YearDropDown.SelectionBackgroundColor = AppColors.TitleColor;
            DPDConstants.UI.TextColor = AppColors.TitleColor;
            DPDConstants.UI.SelectedTextColor = UIColor.White;

            //YearDropDown.TextFont = UIFont.FromName("BPG Mrgvlovani Caps 2010", 15);
            YearDropDown.ClipsToBounds = true;
            YearDropDown.Layer.CornerRadius = 20;

            MonthDropDown.BackgroundColor = UIColor.FromRGB(243, 243, 243);
            MonthDropDown.SelectionBackgroundColor = AppColors.TitleColor;
            DPDConstants.UI.TextColor = AppColors.TitleColor;
            DPDConstants.UI.SelectedTextColor = UIColor.White;

            //MonthDropDown.TextFont = UIFont.FromName("BPG Mrgvlovani Caps 2010", 15);
            MonthDropDown.ClipsToBounds = true;
            MonthDropDown.Layer.CornerRadius = 20;
        }

        private void InitGestures()
        {
            if (yearDropdownView.GestureRecognizers == null || yearDropdownView.GestureRecognizers?.Length == 0)
            {
                yearDropdownView.AddGestureRecognizer(new UITapGestureRecognizer(() =>
                {
                    InitDropDownUI();

                    YearDropDown.Show();
                }));
            }

            if (monthDropdownView.GestureRecognizers == null || monthDropdownView.GestureRecognizers?.Length == 0)
            {
                monthDropdownView.AddGestureRecognizer(new UITapGestureRecognizer(() =>
                {
                    InitDropDownUI();

                    MonthDropDown.Show();
                }));
            }
        }

        public IndicatorInfo IndicatorInfoForPagerTabStrip(PagerTabStripViewController pagerTabStripController)
        {
            return new IndicatorInfo("შედეგები");
        }

        private string[] GetYears(DateTime? minDate, DateTime? maxDate)
        {
            var minYear = minDate?.Year;
            var maxYear = maxDate?.Year;

            if (minDate?.Year != maxDate?.Year)
            {
                var years = Enumerable.Range(minYear.Value, maxYear.Value)?.Select(x => x.ToString())?.ToList();
                years.Insert(0, "წელი");
                return years.ToArray();
            }

            return new string[] { minYear.Value.ToString() };
        }

        private string[] GetMonth()
        {
            cultureInfo = new CultureInfo("ka-GE");

            var month = cultureInfo.DateTimeFormat.MonthNames.ToList();

            month.Insert(0, "თვე");

            return month?.ToArray();
        }
    }
}
